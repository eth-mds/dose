---
output:
  github_document:
    html_preview: true
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, include = FALSE, results = "asis", comment = ""}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  cache.path = "cache/README/",
  fig.path = "figures/README/",
  out.width = "100%"
)

r_dir <- file.path(rprojroot::find_root(".git/index"), "r")
invisible(lapply(list.files(r_dir, full.names = TRUE), source))

library(ggplot2)

cfg <- get_config("concepts", config_dir())
dose_wins <- seq(8, 24, 8)
sofa_win  <- 24
```

# DOSE - Data-driven Organ Severity Evaluation

This repository contains all the code that was used to develop the data-driven organ severity evaluation (DOSE) score (Poster P381 at ISICEM 2020, also soon to be available online). The entirety of the code will be uploaded in the coming weeks.

```{r train, message = FALSE, cache = TRUE}
dat <- load_data("mimic", cfg, hours(-Inf), hours(dose_wins))

train <- dat[[1L]]
train_id <- sample(nrow(train), 0.75 * nrow(train))
train <- train[train_id, ]

dose <- train_dose(train, method = dose_glm, model_ind = 14)
```

```{r, results = 'asis', echo = FALSE}
dose <- train_dose(train, method = dose_rfs)
cat(score2table(dose))
```

The DOSE score, trained on 75% of MIMIC data, 8 hours into ICU stay, is now evaluated on the remaining 25% of data for hours `r dose_wins` and compared to SOFA at hour `r sofa_win`.

```{r mimic, message = FALSE, cache = TRUE}
test <- lapply(dat, function(x) x[-train_id, ])

within <- dose_eval(dose, test)
mimic  <- sofa_eval("mimic", hours(sofa_win), cohort = within)
```

```{r proc, echo = FALSE}
roc_pr_plot(eval_score(mimic), show_cb = TRUE, nrow_legend = 2)
```

Next, we evaluate the DOSE score trained on MIMIC, using data from eICU.

```{r eicu, message = FALSE, cache = TRUE}
eicu  <- load_data("eicu", cfg, hours(-Inf), hours(dose_wins))

betw1 <- dose_eval(dose, eicu)
scor1 <- sofa_eval("eicu", hours(sofa_win), cohort = betw1)
```

```{r bars, echo = FALSE}
aucs <- auc(eval_score(scor1))
aucs <- aucs[, list(mean = mean(aucs), sd = sd(aucs)),
             by = c("modnames", "curvetypes")]
aucs <- aucs[, c("lwr", "upr") := list(mean - sd, mean + sd)]

ggplot(aucs, aes(x = modnames, y = mean)) +
  geom_point() +
  geom_errorbar(aes(ymin = lwr, ymax = upr)) +
  facet_grid(rows = vars(curvetypes), scales = "free_y") +
  theme_bw() +
  ylab("Mean AUC") + xlab(element_blank()) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
```

And finally, we evaluate DOSE trained on MIMIC, using data from HiRID and we visualize how this behaves over time.

```{r hirid, message = FALSE, cache = TRUE}
times <- hours(seq.int(12, 24, 2))

hirid <- load_data("hirid", cfg, hours(-Inf), hours(times))
betw2 <- dose_eval(dose, hirid)
scor2 <- sofa_eval("hirid", times, cohort = betw2)
```

```{r time, echo = FALSE}
aucs <- auc(eval_score(scor2))
aucs <- aucs[, list(mean = mean(aucs), sd = sd(aucs)),
             by = c("modnames", "curvetypes")]
aucs <- aucs[, c("lwr", "upr") := list(mean - sd, mean + sd)]
aucs <- aucs[, c("type", "time") := list(sub(" .+", "", modnames),
  as.integer(sub(".+, ", "", sub(" hours]$", "", modnames)))
)]

ggplot(aucs, aes(x = time, y = mean, color = type, fill = type)) +
  geom_line() +
  geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.3, linetype = 0) +
  facet_grid(rows = vars(curvetypes), scales = "free_y") +
  theme_bw() +
  xlab("Hours in ICU") + ylab("Mean AUC") +
  theme(legend.position = "bottom") +
  scale_colour_brewer(type = "qual", palette = 6, direction = 1)
```
